<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BKSD Dashboard</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --bg-card: #111111;
      --bg-hover: #1a1a1a;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --text-dim: #666666;
      --accent: #00ff88;
      --accent-dim: #00aa55;
      --warning: #ffaa00;
      --error: #ff4444;
      --success: #00ff88;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }

    .header-info {
      display: flex;
      gap: 16px;
      color: var(--text-dim);
      font-size: 12px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--error);
    }

    .connection-dot.connected {
      background: var(--success);
    }

    /* Active Transfer Section */
    .active-section {
      margin-bottom: 32px;
    }

    .active-transfer {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .active-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    /* Animated Squares */
    .spinner {
      position: relative;
      width: 32px;
      height: 32px;
    }

    .spinner .square {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--accent);
      border-radius: 2px;
    }

    .spinner .square:nth-child(1) {
      top: 0; left: 0;
      animation: orbit 2s ease-in-out infinite, pulse 1.5s ease-in-out infinite;
    }

    .spinner .square:nth-child(2) {
      top: 0; right: 0;
      animation: orbit 2s ease-in-out infinite 0.5s, pulse 1.5s ease-in-out infinite 0.375s;
    }

    .spinner .square:nth-child(3) {
      bottom: 0; right: 0;
      animation: orbit 2s ease-in-out infinite 1s, pulse 1.5s ease-in-out infinite 0.75s;
    }

    .spinner .square:nth-child(4) {
      bottom: 0; left: 0;
      animation: orbit 2s ease-in-out infinite 1.5s, pulse 1.5s ease-in-out infinite 1.125s;
    }

    @keyframes orbit {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(11px, 0) rotate(90deg); }
      50% { transform: translate(11px, 11px) rotate(180deg); }
      75% { transform: translate(0, 11px) rotate(270deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .active-title {
      font-weight: 600;
      color: var(--accent);
    }

    .active-subtitle {
      color: var(--text-dim);
      font-size: 12px;
    }

    /* Progress Bar */
    .progress-container {
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-dim), var(--accent));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .progress-percent {
      color: var(--accent);
      font-weight: 600;
    }

    .progress-eta {
      color: var(--text-dim);
    }

    .current-file {
      color: var(--text-dim);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Verifying state */
    .verifying .progress-fill {
      background: linear-gradient(90deg, var(--warning), #ffcc00);
      animation: verifyPulse 1s ease-in-out infinite;
    }

    @keyframes verifyPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* No active transfers */
    .no-active {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
    }

    .no-active-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Jobs Section */
    .jobs-section h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .job-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .job-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .job-card:hover {
      border-color: var(--text-dim);
    }

    .job-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
    }

    .job-expand {
      color: var(--text-dim);
      font-size: 10px;
      transition: transform 0.2s;
    }

    .job-card.expanded .job-expand {
      transform: rotate(90deg);
    }

    .job-status-icon {
      width: 20px;
      text-align: center;
    }

    .job-status-icon.complete { color: var(--success); }
    .job-status-icon.failed { color: var(--error); }
    .job-status-icon.in-progress { color: var(--warning); }

    .job-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .job-time {
      color: var(--text-dim);
      font-size: 12px;
      width: 140px;
    }

    .job-target {
      flex: 1;
      font-weight: 500;
    }

    .job-result {
      color: var(--text-dim);
      font-size: 12px;
    }

    .job-details {
      display: none;
      padding: 0 16px 16px 48px;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    .job-card.expanded .job-details {
      display: block;
    }

    .job-timeline {
      padding-top: 12px;
    }

    .timeline-entry {
      display: flex;
      gap: 12px;
      padding: 4px 0;
      font-size: 12px;
    }

    .timeline-time {
      color: var(--text-dim);
      width: 80px;
    }

    .timeline-status {
      color: var(--text);
    }

    .timeline-desc {
      color: var(--text-dim);
    }

    /* Empty state */
    .empty-jobs {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-dim);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>BKSD Dashboard</h1>
    <div class="header-info">
      <span id="version">v0.0.0</span>
      <span id="uptime">Uptime: --</span>
      <span id="mode"></span>
      <div class="connection-status">
        <div class="connection-dot" id="connectionDot"></div>
        <span id="connectionText">Connecting...</span>
      </div>
    </div>
  </header>

  <section class="active-section">
    <div id="activeTransfer"></div>
  </section>

  <section class="jobs-section">
    <h2>Recent Jobs</h2>
    <div class="job-list" id="jobList"></div>
  </section>

  <script>
    // State
    let ws = null;
    let requestId = 0;
    let pendingRequests = new Map();
    let jobs = [];
    let jobDetails = new Map();
    let expandedJobId = null;

    // WebSocket connection
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        document.getElementById('connectionDot').classList.add('connected');
        document.getElementById('connectionText').textContent = 'Connected';
        fetchDaemonStatus();
        fetchJobs();
        startPolling();
      };

      ws.onclose = () => {
        document.getElementById('connectionDot').classList.remove('connected');
        document.getElementById('connectionText').textContent = 'Disconnected';
        setTimeout(connect, 2000);
      };

      ws.onerror = () => {
        ws.close();
      };

      ws.onmessage = (event) => {
        try {
          const response = JSON.parse(event.data);
          if (response.id && pendingRequests.has(response.id)) {
            const { resolve, reject } = pendingRequests.get(response.id);
            pendingRequests.delete(response.id);
            if (response.error) {
              reject(new Error(response.error.message));
            } else {
              resolve(response.result);
            }
          }
        } catch (e) {
          console.error('Failed to parse response:', e);
        }
      };
    }

    // RPC call helper
    function rpc(method, params = {}) {
      return new Promise((resolve, reject) => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          reject(new Error('Not connected'));
          return;
        }
        const id = ++requestId;
        pendingRequests.set(id, { resolve, reject });
        ws.send(JSON.stringify({
          jsonrpc: '2.0',
          method,
          params,
          id
        }));
        // Timeout after 10s
        setTimeout(() => {
          if (pendingRequests.has(id)) {
            pendingRequests.delete(id);
            reject(new Error('Request timeout'));
          }
        }, 10000);
      });
    }

    // Fetch daemon status
    async function fetchDaemonStatus() {
      try {
        const status = await rpc('daemon.status');
        document.getElementById('version').textContent = `v${status.version}`;
        document.getElementById('uptime').textContent = `Uptime: ${formatDuration(status.uptime_secs)}`;
        document.getElementById('mode').textContent = status.simulation ? '[SIMULATION]' : '';
      } catch (e) {
        console.error('Failed to fetch daemon status:', e);
      }
    }

    // Fetch active progress
    async function fetchActiveProgress() {
      try {
        const result = await rpc('progress.active');
        renderActiveTransfer(result.jobs);
      } catch (e) {
        console.error('Failed to fetch active progress:', e);
      }
    }

    // Fetch jobs list
    async function fetchJobs() {
      try {
        jobs = await rpc('jobs.list', { limit: 20 });
        renderJobs();
      } catch (e) {
        console.error('Failed to fetch jobs:', e);
      }
    }

    // Fetch job details
    async function fetchJobDetails(jobId) {
      try {
        const details = await rpc('jobs.get', { id: jobId });
        jobDetails.set(jobId, details);
        renderJobs();
      } catch (e) {
        console.error('Failed to fetch job details:', e);
      }
    }

    // Render active transfer
    function renderActiveTransfer(activeJobs) {
      const container = document.getElementById('activeTransfer');
      const entries = Object.entries(activeJobs);

      if (entries.length === 0) {
        container.innerHTML = `
          <div class="active-transfer">
            <div class="no-active">
              <div class="no-active-icon">~</div>
              <div>No active transfers</div>
            </div>
          </div>
        `;
        return;
      }

      // Show first active job (typically only one at a time)
      const [jobId, status] = entries[0];
      const job = jobs.find(j => j.id === jobId);
      const targetName = job?.target_id || jobId.slice(0, 8);

      let content = '';

      if (status.state === 'in_progress') {
        const eta = status.eta_seconds ? `ETA: ${formatDuration(status.eta_seconds)}` : '';
        content = `
          <div class="active-transfer">
            <div class="active-header">
              <div class="spinner">
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
              </div>
              <div>
                <div class="active-title">Backing up: ${escapeHtml(targetName)}</div>
                <div class="active-subtitle">${formatBytes(status.bytes_copied)} / ${formatBytes(status.total_bytes)}</div>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${status.percentage}%"></div>
              </div>
              <div class="progress-info">
                <span class="progress-percent">${status.percentage}%</span>
                <span class="progress-eta">${eta}</span>
              </div>
            </div>
            <div class="current-file">${escapeHtml(status.current_file || '')}</div>
          </div>
        `;
      } else if (status.state === 'verifying') {
        const pct = status.total > 0 ? Math.round((status.current / status.total) * 100) : 0;
        content = `
          <div class="active-transfer verifying">
            <div class="active-header">
              <div class="spinner">
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
              </div>
              <div>
                <div class="active-title">Verifying: ${escapeHtml(targetName)}</div>
                <div class="active-subtitle">${status.current} / ${status.total} files</div>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${pct}%"></div>
              </div>
              <div class="progress-info">
                <span class="progress-percent">${pct}%</span>
                <span class="progress-eta">Verifying integrity...</span>
              </div>
            </div>
          </div>
        `;
      } else if (status.state === 'copy_complete') {
        content = `
          <div class="active-transfer">
            <div class="active-header">
              <div class="spinner">
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
              </div>
              <div>
                <div class="active-title">Preparing verification: ${escapeHtml(targetName)}</div>
                <div class="active-subtitle">Copy complete, starting verification...</div>
              </div>
            </div>
          </div>
        `;
      } else {
        content = `
          <div class="active-transfer">
            <div class="active-header">
              <div class="spinner">
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
              </div>
              <div>
                <div class="active-title">${escapeHtml(targetName)}</div>
                <div class="active-subtitle">${status.state}</div>
              </div>
            </div>
          </div>
        `;
      }

      container.innerHTML = content;
    }

    // Render jobs list
    function renderJobs() {
      const container = document.getElementById('jobList');

      if (jobs.length === 0) {
        container.innerHTML = '<div class="empty-jobs">No jobs yet</div>';
        return;
      }

      container.innerHTML = jobs.map(job => {
        const isExpanded = expandedJobId === job.id;
        const details = jobDetails.get(job.id);
        const statusIcon = getStatusIcon(job.status);
        const statusClass = getStatusClass(job.status);
        const time = formatDateTime(job.created_at);
        const result = formatJobResult(job);

        let detailsHtml = '';
        if (isExpanded && details) {
          detailsHtml = `
            <div class="job-details">
              <div class="job-timeline">
                ${details.history.map(entry => `
                  <div class="timeline-entry">
                    <span class="timeline-time">${formatTime(entry.created_at)}</span>
                    <span class="timeline-status">${entry.status}</span>
                    <span class="timeline-desc">${entry.description || ''}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        } else if (isExpanded) {
          detailsHtml = '<div class="job-details"><div class="job-timeline">Loading...</div></div>';
        }

        return `
          <div class="job-card ${isExpanded ? 'expanded' : ''}" data-id="${job.id}">
            <div class="job-header" onclick="toggleJob('${job.id}')">
              <span class="job-expand">&#9654;</span>
              <span class="job-status-icon ${statusClass}">${statusIcon}</span>
              <div class="job-info">
                <span class="job-time">${time}</span>
                <span class="job-target">${escapeHtml(job.target_id)}</span>
                <span class="job-result">${result}</span>
              </div>
            </div>
            ${detailsHtml}
          </div>
        `;
      }).join('');
    }

    // Toggle job expansion
    function toggleJob(jobId) {
      if (expandedJobId === jobId) {
        expandedJobId = null;
      } else {
        expandedJobId = jobId;
        if (!jobDetails.has(jobId)) {
          fetchJobDetails(jobId);
        }
      }
      renderJobs();
    }

    // Helpers
    function getStatusIcon(status) {
      if (status.toLowerCase().includes('complete')) return '\u2713';
      if (status.toLowerCase().includes('fail')) return '\u2717';
      return '\u2022';
    }

    function getStatusClass(status) {
      if (status.toLowerCase().includes('complete')) return 'complete';
      if (status.toLowerCase().includes('fail')) return 'failed';
      return 'in-progress';
    }

    function formatJobResult(job) {
      const status = job.status.toLowerCase();
      if (status.includes('complete')) {
        return 'Complete';
      }
      if (status.includes('fail')) {
        return 'Failed';
      }
      return job.status;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}m ${s}s`;
      }
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return `${h}h ${m}m`;
    }

    function formatDateTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[char]));
    }

    // Polling
    let pollInterval = null;

    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(() => {
        fetchActiveProgress();
        fetchDaemonStatus();
      }, 500);

      // Refresh job list less frequently
      setInterval(fetchJobs, 5000);
    }

    // Initialize
    connect();
  </script>
</body>
</html>
